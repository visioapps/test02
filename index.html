<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#4A90D9">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Amblyup">
<link rel="manifest" href="manifest.json">
<title>Amblyup ‚Äî Jules</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Quicksand:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#4A90D9; --blue-l:#EAF4FF; --blue-mid:#C8E4FA; --blue-d:#2E6DB4;
  --green:#5BBF8E; --green-l:#E8F7F1; --green-d:#3A8F68;
  --orange:#F9A825; --orange-l:#FFF8E1; --orange-d:#E65100;
  --red:#E74C3C; --red-l:#FDEDEC;
  --teal:#3ABFBF; --teal-l:#E0F5F5;
  --text:#2C3E50; --text-m:#7F8C8D; --text-l:#BDC3C7;
  --white:#FFFFFF; --bg:#F4F9FF; --border:#C8E4FA;
  --shadow:0 4px 20px rgba(74,144,217,.12);
  --shadow-lg:0 8px 30px rgba(74,144,217,.20);
  --r:20px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{font-family:'Quicksand',sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden;padding-bottom:80px;}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;}
.page.active{display:block;animation:fadeUp .35s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
@keyframes popIn{0%{transform:scale(0)}80%{transform:scale(1.2)}100%{transform:scale(1)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{0%{background-position:-200px 0}100%{background-position:200px 0}}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header{padding:18px 16px 0;display:flex;align-items:center;justify-content:space-between;}
.header-logo{height:52px;object-fit:contain;}
.header-right{display:flex;align-items:center;gap:8px;}
.notif-btn{width:38px;height:38px;border-radius:12px;background:var(--white);border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.05rem;cursor:pointer;position:relative;box-shadow:var(--shadow);}
.notif-dot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--red);border-radius:50%;border:2px solid var(--white);}

/* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
.card{background:var(--white);border-radius:var(--r);padding:18px;margin:10px 16px 0;box-shadow:var(--shadow);}
.card-title{font-family:'Nunito',sans-serif;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.12em;color:var(--text-m);margin-bottom:12px;}
.section-title{font-family:'Nunito',sans-serif;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.12em;color:var(--text-m);padding:14px 16px 6px;}

/* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
.hero{margin:12px 16px 0;background:var(--blue);border-radius:var(--r);padding:22px 20px 20px;color:white;position:relative;overflow:hidden;box-shadow:0 8px 28px rgba(74,144,217,.35);}
.hero::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;background:rgba(255,255,255,.12);border-radius:50%;}
.hero::after{content:'';position:absolute;bottom:-20px;left:20px;width:80px;height:80px;background:rgba(255,255,255,.08);border-radius:50%;}
.hero-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;position:relative;z-index:1;}
.hero-greeting{font-size:.7rem;font-weight:700;opacity:.85;text-transform:uppercase;letter-spacing:.5px;}
.hero-name{font-family:'Nunito',sans-serif;font-size:1.45rem;font-weight:900;margin-top:2px;}
.hero-msg{font-size:.88rem;font-weight:600;line-height:1.55;opacity:.95;position:relative;z-index:1;margin-bottom:16px;background:rgba(255,255,255,.15);border-radius:14px;padding:12px 14px;}
.hero-msg strong{font-weight:900;opacity:1;}
.hero-mascot{font-size:2.8rem;animation:bounce 2.5s ease-in-out infinite;filter:drop-shadow(0 4px 8px rgba(0,0,0,.2));flex-shrink:0;}
/* Barre progression journ√©e */
.hero-day-progress{position:relative;z-index:1;margin-bottom:14px;}
.hero-day-label{display:flex;justify-content:space-between;font-size:.68rem;font-weight:700;opacity:.85;margin-bottom:5px;}
.hero-day-bar-bg{height:10px;background:rgba(255,255,255,.25);border-radius:20px;overflow:hidden;position:relative;}
.hero-day-bar{height:100%;background:linear-gradient(90deg,rgba(255,255,255,.9),rgba(255,255,255,.6));border-radius:20px;transition:width 1s ease;}
.hero-day-marker{position:absolute;top:-3px;width:16px;height:16px;background:white;border-radius:50%;box-shadow:0 2px 6px rgba(0,0,0,.2);margin-left:-8px;transition:left 1s ease;}
/* Stats */
.hero-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;position:relative;z-index:1;}
.hstat{background:rgba(255,255,255,.2);border-radius:14px;padding:10px 6px;text-align:center;}
.hstat-val{font-family:'Nunito',sans-serif;font-size:1.1rem;font-weight:900;line-height:1;}
.hstat-label{font-size:.58rem;font-weight:600;opacity:.85;margin-top:3px;}

/* ‚îÄ‚îÄ RAPPEL DU JOUR ‚îÄ‚îÄ */
.rappel-jour{margin:12px 16px 0;background:linear-gradient(135deg,var(--blue-l),#dceffe);border:2px solid var(--blue);border-radius:var(--r);padding:16px;box-shadow:var(--shadow);}
.rappel-jour-title{font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;color:var(--blue-d);margin-bottom:6px;display:flex;align-items:center;gap:8px;}
.rappel-jour-text{font-size:.85rem;color:var(--text);line-height:1.55;font-weight:600;}
.rappel-jour-sub{font-size:.75rem;color:var(--text-m);margin-top:8px;}

/* ‚îÄ‚îÄ PATCH POS√â ‚îÄ‚îÄ */
.patch-card{margin:10px 16px 0;}
.patch-question{font-family:'Nunito',sans-serif;font-weight:800;font-size:.95rem;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.patch-jours{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.patch-jour-item{display:flex;align-items:center;justify-content:space-between;background:var(--orange-l);border:1.5px solid var(--orange);border-radius:14px;padding:10px 14px;}
.patch-jour-label{font-family:'Nunito',sans-serif;font-weight:700;font-size:.85rem;color:var(--orange-d);}
.patch-fait-btn{background:var(--green);color:white;border:none;border-radius:10px;padding:7px 14px;font-family:'Nunito',sans-serif;font-weight:800;font-size:.78rem;cursor:pointer;transition:all .15s;}
.patch-fait-btn:active{transform:scale(.95);}

/* ‚îÄ‚îÄ HOURS GRID ‚îÄ‚îÄ */
.obj-row{display:flex;align-items:center;justify-content:space-between;font-size:.78rem;color:var(--text-m);margin-bottom:10px;}
.obj-badge{background:var(--orange-l);color:var(--orange-d);border-radius:20px;padding:4px 10px;font-family:'Nunito',sans-serif;font-weight:700;font-size:.72rem;}
.hours-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px;}
.hbtn{aspect-ratio:1;border-radius:12px;border:2px solid transparent;background:var(--blue-l);font-family:'Nunito',sans-serif;font-weight:800;font-size:1.2rem;color:var(--blue);cursor:pointer;transition:all .15s;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;}
.hbtn .hbtn-sub{font-size:.56rem;font-weight:600;opacity:.8;font-family:'Quicksand',sans-serif;}
.hbtn:hover,.hbtn.sel{background:var(--blue);color:white;border-color:var(--blue);transform:scale(1.05);}
.hbtn.zero:hover,.hbtn.zero.sel{background:var(--red);color:white;border-color:var(--red);}
.hbtn.target{background:var(--orange-l);color:var(--orange-d);border-color:var(--orange);}
.hbtn.target:hover,.hbtn.target.sel{background:var(--orange);color:white;border-color:var(--orange);transform:scale(1.05);}
.hbtn.over{background:var(--green-l);color:var(--green-d);border-color:var(--green);}
.hbtn.over:hover,.hbtn.over.sel{background:var(--green);color:white;border-color:var(--green);transform:scale(1.05);}
.valider-btn{width:100%;padding:15px;border-radius:14px;border:none;background:var(--blue);color:white;font-family:'Nunito',sans-serif;font-weight:800;font-size:1rem;cursor:pointer;transition:all .15s;box-shadow:0 4px 16px rgba(74,144,217,.35);display:flex;align-items:center;justify-content:center;gap:8px;}
.valider-btn:disabled{background:var(--border);color:var(--text-l);box-shadow:none;cursor:not-allowed;}
.valider-btn:not(:disabled):active{transform:scale(.97);}
.congrats-box{background:linear-gradient(135deg,var(--green-l),#d4f0e5);border-radius:var(--r);padding:20px;text-align:center;margin-top:12px;display:none;}
.congrats-box .c-emoji{font-size:2.5rem;display:block;margin-bottom:8px;animation:popIn .4s cubic-bezier(.34,1.56,.64,1);}
.congrats-box h3{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.2rem;color:var(--green);margin-bottom:4px;}
.congrats-box p{color:var(--text-m);font-size:.85rem;}

/* ‚îÄ‚îÄ CALENDRIER ‚îÄ‚îÄ */
.cal-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.cal-nav{display:flex;align-items:center;gap:8px;}
.cal-nav-btn{width:30px;height:30px;border-radius:9px;background:var(--blue-l);border:1.5px solid var(--blue-mid);color:var(--blue);font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;font-weight:800;}
.cal-nav-btn:active{background:var(--blue);color:white;transform:scale(.93);}
.cal-month-label{font-family:'Nunito',sans-serif;font-weight:900;font-size:.95rem;color:var(--text);min-width:100px;text-align:center;}
.cal-score-val{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.35rem;color:var(--blue);line-height:1;text-align:right;}
.cal-score-label{font-size:.62rem;color:var(--text-m);}
.cal-day-labels{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:3px;}
.cdl{text-align:center;font-family:'Nunito',sans-serif;font-size:.6rem;font-weight:700;color:var(--text-l);text-transform:uppercase;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cday{aspect-ratio:1;border-radius:9px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:'Nunito',sans-serif;font-size:.62rem;font-weight:700;transition:transform .15s;position:relative;cursor:default;}
/* ‚îÄ‚îÄ CDAY : fond = ≈ìil, point = observance ‚îÄ‚îÄ */
.cday.empty{background:none;}
.cday.future{background:var(--bg);color:var(--text-l);}
/* ≈íil droit ‚Üí bleu */
.cday.od-day  { background:#4A90D9; color:white; }
/* ≈íil gauche ‚Üí teal */
.cday.og-day  { background:#3ABFBF; color:white; }
/* Pas de cache ‚Üí gris neutre */
.cday.no-day  { background:#CBD5E1; color:#64748B; }
/* Aujourd'hui ‚Üí anneau bleu fonc√© */
.cday.today   { background:#2E6DB4; color:white; box-shadow:0 3px 10px rgba(74,144,217,.45); }
.cday.od-day:hover,.cday.og-day:hover,.cday.no-day:hover,.cday.today:hover{ transform:scale(1.1); }

/* Point observance sous la date */
.cday-obs-dot {
  width:6px; height:6px; border-radius:50%; margin-top:2px; flex-shrink:0;
  border:1px solid rgba(255,255,255,.5);
}
.cday-obs-dot.dot-ok      { background:#5BBF8E; }   /* objectif rempli ‚Üí vert */
.cday-obs-dot.dot-partial { background:#F0C040; }   /* partiel ‚Üí ambre */
.cday-obs-dot.dot-miss    { background:#E74C3C; }   /* pas de cache ‚Üí rouge */
.cday-obs-dot.dot-none    { background:transparent; border-color:transparent; }
.cday-num{font-size:.6rem;line-height:1;font-weight:800;}
.cday-eye{font-size:.44rem;font-weight:900;background:rgba(255,255,255,.25);border-radius:3px;padding:0 2px;line-height:1.4;margin-top:1px;}
/* L√©gende */
.cal-legend-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 12px;margin-top:12px;}
.cal-leg{display:flex;align-items:center;gap:6px;font-size:.7rem;color:var(--text-m);font-weight:600;}
.cal-leg-dot{width:22px;height:22px;border-radius:7px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.55rem;font-weight:800;color:white;}
.cal-leg-dot.ok{background:var(--green);}
.cal-leg-dot.partial{background:var(--orange);}
.cal-leg-dot.miss{background:var(--red-l);color:var(--red);border:1.5px solid #FECACA;}
.cal-leg-dot.future{background:var(--bg);border:1.5px solid var(--border);color:var(--text-l);}
.cal-leg-desc{line-height:1.3;}

/* ‚îÄ‚îÄ AJOUTER √âV√âNEMENT ‚îÄ‚îÄ */
.add-event-btn{width:100%;padding:13px;border-radius:14px;border:2px dashed var(--blue-mid);background:var(--blue-l);color:var(--blue);font-family:'Nunito',sans-serif;font-weight:700;font-size:.88rem;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px;}
.add-event-btn:active{transform:scale(.97);}

/* ‚îÄ‚îÄ RDV ‚îÄ‚îÄ */
.rdv-list{border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);margin:10px 16px 0;}
.rdv-item{background:var(--white);padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s;}
.rdv-item:last-child{border-bottom:none;}
.rdv-item:active{background:var(--bg);}
.rdv-date-box{width:46px;height:50px;border-radius:13px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;}
.rdv-date-box.next{background:var(--blue);box-shadow:0 4px 12px rgba(74,144,217,.3);}
.rdv-date-box.fut{background:var(--bg);border:2px solid var(--border);}
.rdv-date-box.warn{background:var(--orange-l);border:2px solid var(--orange);}
.rdv-day{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.1rem;line-height:1;color:white;}
.rdv-date-box.fut .rdv-day,.rdv-date-box.warn .rdv-day{color:var(--text);}
.rdv-date-box.warn .rdv-day{color:var(--orange-d);}
.rdv-mois{font-family:'Nunito',sans-serif;font-weight:700;font-size:.58rem;color:rgba(255,255,255,.85);text-transform:uppercase;}
.rdv-date-box.fut .rdv-mois{color:var(--text-m);}
.rdv-date-box.warn .rdv-mois{color:var(--orange-d);}
.rdv-info{flex:1;}
.rdv-type{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;}
.rdv-detail{font-size:.72rem;color:var(--text-m);margin-top:3px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.rdv-badge{display:inline-flex;padding:3px 8px;border-radius:20px;font-size:.63rem;font-weight:700;font-family:'Nunito',sans-serif;}
.rdv-badge.next{background:var(--blue-l);color:var(--blue);}
.rdv-badge.ok{background:var(--green-l);color:var(--green-d);}
.rdv-badge.attente{background:var(--orange-l);color:var(--orange-d);}
.rdv-arrow{color:var(--text-l);font-size:1rem;}
.rdv-link-btn{width:100%;padding:12px;border-radius:14px;border:none;margin-top:4px;font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:8px;}
.rdv-link-btn.ortho{background:var(--blue);color:white;box-shadow:0 4px 14px rgba(74,144,217,.3);}
.rdv-link-btn.ophtalmo{background:var(--teal);color:white;box-shadow:0 4px 14px rgba(58,191,191,.3);}
.rdv-link-btn:active{transform:scale(.97);}

/* ‚îÄ‚îÄ PROGR√àS ‚îÄ‚îÄ */
.vision-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.vision-tabs{display:flex;gap:4px;}
.vtab{padding:4px 10px;border-radius:8px;font-family:'Nunito',sans-serif;font-size:.7rem;font-weight:700;border:1.5px solid var(--border);background:var(--bg);color:var(--text-m);cursor:pointer;transition:all .15s;}
.vtab.active{background:var(--blue);border-color:var(--blue);color:white;}
.vision-eyes{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.eye-stat{border-radius:14px;padding:12px;text-align:center;border:2px solid var(--border);}
.eye-od{border-color:var(--blue);background:var(--blue-l);}
.eye-og{border-color:var(--green);background:var(--green-l);}
.eye-label{font-size:.63rem;font-weight:700;color:var(--text-m);text-transform:uppercase;letter-spacing:.4px;margin-bottom:3px;}
.eye-val{font-family:'Nunito',sans-serif;font-weight:900;font-size:1.55rem;line-height:1;}
.eye-od .eye-val{color:var(--blue);}
.eye-og .eye-val{color:var(--green-d);}
.eye-prog{font-size:.7rem;font-weight:700;margin-top:3px;color:var(--green-d);}
.chart-wrap{position:relative;height:140px;}
.chart-labels-y{position:absolute;left:0;top:0;bottom:20px;width:24px;display:flex;flex-direction:column;justify-content:space-between;align-items:flex-end;padding-right:4px;}
.chart-labels-y span{font-size:.54rem;color:var(--text-l);font-family:'Nunito',sans-serif;font-weight:700;}
.chart-svg{position:absolute;left:24px;right:0;top:0;bottom:0;}
.vision-legend{display:flex;gap:14px;margin-top:8px;}
.vleg{display:flex;align-items:center;gap:5px;font-size:.7rem;color:var(--text-m);font-weight:600;}
.vleg-line{width:16px;height:3px;border-radius:2px;}

/* ‚îÄ‚îÄ TAUX OBSERVANCE ‚îÄ‚îÄ */
.obs-big{text-align:center;padding:10px 0 6px;}
.obs-pct{font-family:'Nunito',sans-serif;font-weight:900;font-size:3rem;color:var(--blue);line-height:1;}
.obs-label{font-size:.8rem;color:var(--text-m);margin-top:4px;}
.obs-bar-wrap{height:16px;background:var(--bg);border-radius:20px;overflow:hidden;margin:12px 0;}
.obs-bar{height:100%;background:linear-gradient(90deg,var(--blue),var(--green));border-radius:20px;transition:width 1s ease;}
.obs-months{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:4px;}
.obs-month{background:var(--bg);border-radius:12px;padding:10px 8px;text-align:center;border:1.5px solid var(--border);}
.obs-month-val{font-family:'Nunito',sans-serif;font-weight:800;font-size:.95rem;color:var(--blue);}
.obs-month-label{font-size:.65rem;color:var(--text-m);margin-top:2px;}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.stars-row{display:flex;justify-content:center;gap:4px;flex-wrap:wrap;margin-bottom:10px;}
.star{font-size:1.35rem;transition:transform .2s cubic-bezier(.34,1.56,.64,1);}
.star.filled{animation:popIn .3s ease-out both;}
.stars-sub{text-align:center;font-size:.75rem;color:var(--text-m);margin-bottom:12px;}
.badges-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.badge-item{display:flex;flex-direction:column;align-items:center;gap:5px;padding:12px 5px;border-radius:14px;border:2px solid var(--border);background:var(--bg);opacity:.4;}
.badge-item.unlocked{background:var(--orange-l);border-color:var(--orange);opacity:1;}
.badge-item.unlocked:hover{transform:scale(1.06);transition:transform .15s cubic-bezier(.34,1.56,.64,1);}
.badge-icon{font-size:1.5rem;}
.badge-name{font-family:'Nunito',sans-serif;font-size:.58rem;font-weight:800;color:var(--text-m);text-align:center;line-height:1.2;}
.badge-item.unlocked .badge-name{color:var(--orange-d);}
.badge-row{background:var(--white);border-radius:16px;padding:13px 15px;display:flex;align-items:center;gap:12px;border:1.5px solid var(--border);box-shadow:var(--shadow);margin-bottom:8px;}
.badge-row.unlocked{border-color:var(--orange);background:var(--orange-l);}
.badge-row-icon{width:48px;height:48px;border-radius:14px;background:var(--bg);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.6rem;flex-shrink:0;}
.badge-row.unlocked .badge-row-icon{background:var(--white);border-color:var(--orange);}
.badge-row-info{flex:1;}
.badge-row-name{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;}
.badge-row-desc{font-size:.72rem;color:var(--text-m);margin-top:2px;}
.badge-row-status{font-size:.75rem;font-weight:700;}
.badge-row.unlocked .badge-row-status{color:var(--green-d);}
.badge-row:not(.unlocked) .badge-row-status{color:var(--text-l);}

/* ‚îÄ‚îÄ DOCS ‚îÄ‚îÄ */
.doc-section-hd{font-family:'Nunito',sans-serif;font-size:.8rem;font-weight:900;text-transform:uppercase;letter-spacing:.1em;padding:14px 16px 6px;color:var(--text-m);display:flex;align-items:center;gap:6px;}
.doc-list{margin:0 16px 4px;display:flex;flex-direction:column;gap:6px;}
.doc-item{background:var(--white);border-radius:16px;border:1.5px solid var(--border);box-shadow:var(--shadow);cursor:pointer;transition:all .15s;overflow:hidden;}
.doc-item:active{transform:scale(.98);}
.doc-item-hd{padding:13px 16px;display:flex;align-items:center;gap:12px;}
.doc-item-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0;}
.doc-item-icon.blue{background:var(--blue-l);}
.doc-item-icon.green{background:var(--green-l);}
.doc-item-icon.orange{background:var(--orange-l);}
.doc-item-icon.teal{background:var(--teal-l);}
.doc-item-icon.red{background:var(--red-l);}
.doc-item-info{flex:1;}
.doc-item-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;color:var(--text);}
.doc-item-sub{font-size:.72rem;color:var(--text-m);margin-top:2px;}
.doc-item-arrow{color:var(--text-l);font-size:.95rem;transition:transform .2s;}
.doc-item.open .doc-item-arrow{transform:rotate(90deg);}
.doc-item-body{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .3s ease,padding .3s ease;}
.doc-item.open .doc-item-body{max-height:500px;padding:0 16px 14px;}
.doc-sub-list{display:flex;flex-direction:column;gap:6px;}
.doc-sub-item{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:12px;background:var(--bg);cursor:pointer;transition:background .1s;border:1px solid var(--border);}
.doc-sub-item:active{background:var(--blue-l);}
.doc-sub-icon{font-size:1rem;flex-shrink:0;}
.doc-sub-text{font-size:.82rem;font-weight:600;color:var(--text);flex:1;}
.doc-sub-badge{font-size:.62rem;font-weight:700;padding:2px 7px;border-radius:10px;}
.doc-sub-badge.new{background:var(--blue-l);color:var(--blue);}
.doc-sub-badge.pdf{background:var(--red-l);color:var(--red);}
.doc-sub-badge.video{background:var(--orange-l);color:var(--orange-d);}

/* ‚îÄ‚îÄ ORDONNANCES ‚îÄ‚îÄ */
.ordo-item{background:var(--white);border-radius:16px;border:2px solid var(--blue);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;box-shadow:var(--shadow);}
.ordo-icon{width:44px;height:44px;border-radius:12px;background:var(--blue-l);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.ordo-info{flex:1;}
.ordo-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;}
.ordo-date{font-size:.72rem;color:var(--text-m);margin-top:2px;}
.ordo-btn{background:var(--blue);color:white;border:none;border-radius:10px;padding:7px 12px;font-family:'Nunito',sans-serif;font-weight:700;font-size:.75rem;cursor:pointer;}

/* ‚îÄ‚îÄ KITS ‚îÄ‚îÄ */
.kit-card{background:var(--white);border-radius:16px;border:1.5px solid var(--border);margin-bottom:8px;box-shadow:var(--shadow);overflow:hidden;}
.kit-hd{padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;}
.kit-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.kit-info{flex:1;}
.kit-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;}
.kit-sub{font-size:.72rem;color:var(--text-m);margin-top:2px;}
.kit-body{padding:0 16px;max-height:0;overflow:hidden;transition:max-height .3s ease,padding .3s ease;}
.kit-card.open .kit-body{max-height:300px;padding:0 16px 14px;}
.kit-dl-btn{width:100%;padding:11px;border-radius:12px;border:none;font-family:'Nunito',sans-serif;font-weight:700;font-size:.82rem;cursor:pointer;margin-bottom:6px;display:flex;align-items:center;justify-content:center;gap:6px;transition:all .15s;}
.kit-dl-btn:active{transform:scale(.97);}
.kit-dl-btn.blue{background:var(--blue);color:white;box-shadow:0 3px 12px rgba(74,144,217,.3);}
.kit-dl-btn.orange{background:var(--orange);color:white;}
.kit-dl-btn.green{background:var(--green);color:white;}

/* ‚îÄ‚îÄ R√âGLAGES ‚îÄ‚îÄ */
.settings-section{margin:0 16px 4px;}
.settings-item{background:var(--white);border-radius:16px;border:1.5px solid var(--border);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;box-shadow:var(--shadow);cursor:pointer;transition:background .1s;}
.settings-item:active{background:var(--bg);}
.settings-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.settings-info{flex:1;}
.settings-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;}
.settings-sub{font-size:.72rem;color:var(--text-m);margin-top:2px;}
.settings-arrow{color:var(--text-l);font-size:.9rem;}
.toggle-row{background:var(--white);border-radius:16px;border:1.5px solid var(--border);padding:14px 16px;display:flex;align-items:center;gap:12px;margin-bottom:8px;box-shadow:var(--shadow);}
.toggle-info{flex:1;}
.toggle-title{font-family:'Nunito',sans-serif;font-weight:800;font-size:.88rem;}
.toggle-sub{font-size:.72rem;color:var(--text-m);margin-top:2px;}
.toggle{position:relative;width:42px;height:24px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border);border-radius:20px;cursor:pointer;transition:.2s;}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s;box-shadow:0 1px 4px rgba(0,0,0,.15);}
.toggle input:checked + .toggle-slider{background:var(--blue);}
.toggle input:checked + .toggle-slider::before{transform:translateX(18px);}

/* ‚îÄ‚îÄ PERMISSION BANNER ‚îÄ‚îÄ */
.perm-banner{background:var(--orange-l);border:2px solid var(--orange);border-radius:14px;padding:14px 16px;margin:10px 16px 0;display:none;animation:fadeUp .4s ease;}
.perm-banner p{font-size:.85rem;color:var(--text);font-weight:600;}
.perm-banner button{margin-top:8px;background:var(--orange);color:white;border:none;border-radius:10px;padding:8px 16px;font-family:'Nunito',sans-serif;font-weight:700;cursor:pointer;font-size:.85rem;display:flex;align-items:center;gap:6px;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.94);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-top:1.5px solid var(--border);display:grid;grid-template-columns:repeat(4,1fr);padding:8px 0 16px;z-index:100;}
.bnav{display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:4px;border:none;background:none;font-family:'Quicksand',sans-serif;position:relative;transition:all .15s;}
.bnav-img{width:28px;height:28px;object-fit:contain;transition:transform .2s cubic-bezier(.34,1.56,.64,1);}
.bnav-label{font-size:.58rem;font-weight:700;color:var(--text-m);}
.bnav.active .bnav-img{transform:scale(1.2);}
.bnav.active .bnav-label{color:var(--blue);font-weight:800;}
.bnav-badge{position:absolute;top:0;right:50%;margin-right:-18px;background:var(--red);color:white;font-size:.5rem;font-weight:800;padding:2px 5px;border-radius:10px;font-family:'Nunito',sans-serif;min-width:16px;text-align:center;}

/* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */
.confetti-wrap{position:fixed;inset:0;pointer-events:none;z-index:999;display:none;}
.confetti-wrap.show{display:block;}
.confetti{position:absolute;border-radius:2px;animation:confettiFall var(--dur) ease-in forwards;animation-delay:var(--delay);}
@keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}

/* ‚îÄ‚îÄ NOTIFICATION STATUS ‚îÄ‚îÄ */
.notif-status{display:inline-flex;align-items:center;gap:6px;background:var(--blue-l);color:var(--blue);border-radius:30px;padding:6px 14px;font-family:'Nunito',sans-serif;font-size:.8rem;font-weight:700;margin-top:10px;}

/* spacing helpers */
.pb8{padding-bottom:8px;}
.mt8{margin-top:8px;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE : MON AGENDA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page-agenda">

  <div class="app-header">
    <img src="amblyup-logo.png" alt="Amblyup" class="header-logo">
    <div class="header-right">
      <button class="notif-btn" onclick="envoyerNotif('cache')">üîî<div class="notif-dot" id="notif-dot"></div></button>
    </div>
  </div>

  <!-- HERO -->
  <div class="hero">
    <div class="hero-top">
      <div>
        <div class="hero-greeting">üëã Bonjour</div>
        <div class="hero-name" id="hero-name">Jules !</div>
      </div>
      <div id="mascot" style="font-size:2.8rem;animation:bounce 2.5s ease-in-out infinite;filter:drop-shadow(0 4px 8px rgba(0,0,0,.2));flex-shrink:0">ü¶∏</div>
    </div>
    <!-- Message du jour -->
    <div class="hero-msg" id="hero-msg-day">
      Nous sommes <strong id="hero-date-str">...</strong><br>
      Aujourd'hui : cache sur<br><span style="font-size:1.15rem;font-weight:900;letter-spacing:.01em;">üëÅ ton ≈ìil droit</span><br><span style="font-size:.85rem;opacity:.9;">de 8h √† 18h ¬∑ objectif 10h üéØ</span>
      <span style="margin-top:4px;display:block">Bon courage champion ! üí™</span>
    </div>
    <!-- Barre de progression de la journ√©e -->
    <div class="hero-day-progress">
      <div class="hero-day-label">
        <span>8h00</span>
        <span id="hero-now-label">maintenant</span>
        <span>18h00</span>
      </div>
      <div class="hero-day-bar-bg">
        <div class="hero-day-bar" id="hero-day-bar" style="width:0%"></div>
        <div class="hero-day-marker" id="hero-day-marker" style="left:0%"></div>
      </div>
    </div>
    <div class="hero-stats">
      <div class="hstat"><div class="hstat-val">üî• 12</div><div class="hstat-label">Jours d'affil√©e</div></div>
      <div class="hstat"><div class="hstat-val">84%</div><div class="hstat-label">Ce mois</div></div>
      <div class="hstat"><div class="hstat-val">‚≠ê 47</div><div class="hstat-label">√âtoiles</div></div>
    </div>
  </div>

  <!-- PERMISSION BANNER -->
  <div class="perm-banner" id="perm-banner">
    <p>üîî Active les notifications pour les rappels de Jules !</p>
    <button onclick="demanderPermission()">üîî Activer</button>
  </div>

  <!-- JOURS √Ä COMPL√âTER -->
  <div id="pending-section">
    <div class="section-title">üìã Jours √† compl√©ter</div>
    <div class="card" style="margin:0 16px;">
      <div style="font-family:'Nunito',sans-serif;font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:14px;line-height:1.5;">
        Combien d'heures as-tu r√©ussi √† porter le cache ces jours-ci ?
      </div>
      <div id="pending-list"></div>
    </div>
  </div>

  <!-- CALENDRIER -->
  <div class="section-title">üìÖ Calendrier mensuel</div>
  <div class="card">
    <div class="cal-hd">
      <div class="cal-nav">
        <button class="cal-nav-btn" onclick="calPrev()">‚Äπ</button>
        <div class="cal-month-label" id="cal-month-label">F√©vrier 2026</div>
        <button class="cal-nav-btn" onclick="calNext()">‚Ä∫</button>
      </div>
      <div><div class="cal-score-val" id="cal-score-val">84%</div><div class="cal-score-label">observance</div></div>
    </div>
    <div class="cal-day-labels"><div class="cdl">L</div><div class="cdl">M</div><div class="cdl">M</div><div class="cdl">J</div><div class="cdl">V</div><div class="cdl">S</div><div class="cdl">D</div></div>
    <div class="cal-grid" id="cal-grid"></div>
    <!-- L√©gende 2 dimensions -->
    <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px;display:flex;flex-direction:column;gap:14px;">
      <div>
        <div style="font-family:'Nunito',sans-serif;font-size:.63rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--text-m);margin-bottom:8px;">Couleur de la case = quel ≈ìil</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <div style="display:flex;align-items:center;gap:5px;">
            <div style="width:30px;height:30px;border-radius:8px;background:#4A90D9;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;flex-shrink:0;">
              <span style="font-size:.56rem;font-weight:800;color:white;line-height:1;">12</span>
              <span style="font-size:.38rem;font-weight:900;background:rgba(255,255,255,.25);border-radius:2px;padding:0 2px;color:white;line-height:1.4;">OD</span>
              <div style="width:9px;height:9px;border-radius:50%;background:#5BBF8E;border:1.5px solid rgba(58,143,104,.5);margin-top:1px;"></div>
            </div>
            <span style="font-size:.75rem;font-weight:700;color:var(--text);">≈íil <strong>Droit</strong><br><span style="color:var(--text-m);font-size:.65rem;font-weight:600;">lun + mar</span></span>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div style="width:30px;height:30px;border-radius:8px;background:#3ABFBF;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;flex-shrink:0;">
              <span style="font-size:.56rem;font-weight:800;color:white;line-height:1;">15</span>
              <span style="font-size:.38rem;font-weight:900;background:rgba(255,255,255,.25);border-radius:2px;padding:0 2px;color:white;line-height:1.4;">OG</span>
              <div style="width:9px;height:9px;border-radius:50%;background:#5BBF8E;border:1.5px solid rgba(58,143,104,.5);margin-top:1px;"></div>
            </div>
            <span style="font-size:.75rem;font-weight:700;color:var(--text);">≈íil <strong>Gauche</strong><br><span style="color:var(--text-m);font-size:.65rem;font-weight:600;">mer + jeu + ven</span></span>
          </div>
          <div style="display:flex;align-items:center;gap:5px;">
            <div style="width:30px;height:30px;border-radius:8px;background:#CBD5E1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1px;flex-shrink:0;">
              <span style="font-size:.56rem;font-weight:800;color:#64748B;line-height:1;">8</span>
              <span style="font-size:.38rem;font-weight:900;background:rgba(0,0,0,.1);border-radius:2px;padding:0 2px;color:#64748B;line-height:1.4;">‚Äî</span>
              <div style="width:9px;height:9px;border-radius:50%;background:transparent;border:1.5px solid transparent;margin-top:1px;"></div>
            </div>
            <span style="font-size:.75rem;font-weight:700;color:var(--text);">Pas de cache<br><span style="color:var(--text-m);font-size:.65rem;font-weight:600;">sam + dim</span></span>
          </div>
        </div>
      </div>
      <div>
        <div style="font-family:'Nunito',sans-serif;font-size:.63rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:var(--text-m);margin-bottom:8px;">Point en bas = observance du jour</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:13px;height:13px;border-radius:50%;background:#27AE60;border:1.5px solid rgba(39,174,96,.4);flex-shrink:0;"></div><span style="font-size:.75rem;font-weight:700;color:var(--text);">Objectif <strong style="color:#27AE60">rempli</strong></span></div>
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:13px;height:13px;border-radius:50%;background:#F39C12;border:1.5px solid rgba(243,156,18,.4);flex-shrink:0;"></div><span style="font-size:.75rem;font-weight:700;color:var(--text);"><strong style="color:#9A7D0A">Partiel</strong></span></div>
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:13px;height:13px;border-radius:50%;background:#E74C3C;border:1.5px solid rgba(231,76,60,.4);flex-shrink:0;"></div><span style="font-size:.75rem;font-weight:700;color:var(--text);"><strong style="color:#E74C3C">Manqu√©</strong></span></div>
          <div style="display:flex;align-items:center;gap:6px;"><div style="width:13px;height:13px;border-radius:50%;background:rgba(100,116,139,.2);border:1.5px solid rgba(100,116,139,.5);display:flex;align-items:center;justify-content:center;font-size:.42rem;font-weight:900;color:#64748B;flex-shrink:0;">?</div><span style="font-size:.75rem;font-weight:700;color:var(--text);">Non renseign√©</span></div>
        </div>
      </div>
    </div>
  </div>

  <div style="margin:10px 16px 0;">
    <button class="add-event-btn" onclick="showToast('Bient√¥t disponible üöß','blue')">
      ‚ûï Ajouter un √©v√©nement (lunettes perdues, cass√©es...)
    </button>
  </div>

  <!-- RDV -->
  <div class="section-title">üóì Mes rendez-vous</div>
  <div class="rdv-list">
    <div class="rdv-item">
      <div class="rdv-date-box next"><div class="rdv-day">03</div><div class="rdv-mois">Mar</div></div>
      <div class="rdv-info">
        <div class="rdv-type">Bilan orthoptique</div>
        <div class="rdv-detail">14h00 ¬∑ Mme Lecomte <span class="rdv-badge next">Dans 8 jours</span></div>
      </div>
      <div class="rdv-arrow">‚Ä∫</div>
    </div>
    <div class="rdv-item">
      <div class="rdv-date-box fut"><div class="rdv-day">07</div><div class="rdv-mois" style="color:var(--text-m)">Avr</div></div>
      <div class="rdv-info">
        <div class="rdv-type">Contr√¥le ophtalmologue</div>
        <div class="rdv-detail">10h30 ¬∑ Dr. Benali <span class="rdv-badge ok">Confirm√© ‚úì</span></div>
      </div>
      <div class="rdv-arrow">‚Ä∫</div>
    </div>
    <div class="rdv-item">
      <div class="rdv-date-box warn"><div class="rdv-day" style="color:var(--orange-d)">?</div><div class="rdv-mois" style="color:var(--orange-d)">Jun</div></div>
      <div class="rdv-info">
        <div class="rdv-type">Prochain suivi</div>
        <div class="rdv-detail"><span class="rdv-badge attente">√Ä planifier</span></div>
      </div>
      <div class="rdv-arrow">‚Ä∫</div>
    </div>
  </div>

  <!-- PRENDRE RDV -->
  <div class="section-title">üìû Prendre rendez-vous</div>
  <div style="margin:0 16px;display:flex;flex-direction:column;gap:8px;padding-bottom:8px;">
    <button class="rdv-link-btn ortho" onclick="showToast('Ouverture Doctolib‚Ä¶','blue')">üìÖ Prendre RDV orthoptiste</button>
    <button class="rdv-link-btn ophtalmo" onclick="showToast('Ouverture Doctolib‚Ä¶','teal')">üëÅ Prendre RDV ophtalmologue</button>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE : MES PROGR√àS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-progres">

  <div class="app-header">
    <img src="amblyup-logo.png" alt="Amblyup" class="header-logo">
  </div>

  <!-- COURBE VISION -->
  <div class="section-title">üëÅ Courbe d'acuit√© visuelle</div>
  <div class="card">
    <div class="vision-hd">
      <div style="font-family:'Nunito',sans-serif;font-weight:800;font-size:.95rem;">Progression</div>
      <div class="vision-tabs">
        <button class="vtab active" onclick="activateVtab(this)">3 mois</button>
        <button class="vtab" onclick="activateVtab(this)">6 mois</button>
        <button class="vtab" onclick="activateVtab(this)">Tout</button>
      </div>
    </div>
    <div class="vision-eyes">
      <div class="eye-stat eye-od"><div class="eye-label">≈íil droit (OD)</div><div class="eye-val">5/10</div><div class="eye-prog">‚Üë +2/10 depuis d√©c.</div></div>
      <div class="eye-stat eye-og"><div class="eye-label">≈íil gauche (OG)</div><div class="eye-val">9/10</div><div class="eye-prog">‚Üë +1/10 depuis d√©c.</div></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-labels-y"><span>10</span><span>8</span><span>6</span><span>4</span><span>2</span></div>
      <div class="chart-svg">
        <svg viewBox="0 0 340 120" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%">
          <defs>
            <linearGradient id="gOD" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#4A90D9" stop-opacity=".2"/><stop offset="100%" stop-color="#4A90D9" stop-opacity="0"/></linearGradient>
            <linearGradient id="gOG" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#5BBF8E" stop-opacity=".2"/><stop offset="100%" stop-color="#5BBF8E" stop-opacity="0"/></linearGradient>
          </defs>
          <line x1="0" y1="0" x2="340" y2="0" stroke="#EAF4FF" stroke-width="1"/>
          <line x1="0" y1="24" x2="340" y2="24" stroke="#EAF4FF" stroke-width="1"/>
          <line x1="0" y1="48" x2="340" y2="48" stroke="#EAF4FF" stroke-width="1"/>
          <line x1="0" y1="72" x2="340" y2="72" stroke="#EAF4FF" stroke-width="1"/>
          <line x1="0" y1="96" x2="340" y2="96" stroke="#EAF4FF" stroke-width="1"/>
          <polygon points="0,67 56,67 113,58 170,58 226,48 340,48 340,100 0,100" fill="url(#gOD)"/>
          <polyline points="0,67 56,67 113,58 170,58 226,48 340,48" fill="none" stroke="#4A90D9" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>
          <circle cx="0" cy="67" r="4" fill="#4A90D9" stroke="white" stroke-width="2"/><circle cx="113" cy="58" r="4" fill="#4A90D9" stroke="white" stroke-width="2"/><circle cx="226" cy="48" r="4" fill="#4A90D9" stroke="white" stroke-width="2"/><circle cx="340" cy="48" r="5" fill="#4A90D9" stroke="white" stroke-width="2.5"/>
          <text x="326" y="41" font-size="9" fill="#2E6DB4" font-weight="800" font-family="Nunito">5/10</text>
          <polygon points="0,19 56,19 113,19 170,10 226,10 340,10 340,50 0,50" fill="url(#gOG)"/>
          <polyline points="0,19 56,19 113,19 170,10 226,10 340,10" fill="none" stroke="#5BBF8E" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>
          <circle cx="0" cy="19" r="4" fill="#5BBF8E" stroke="white" stroke-width="2"/><circle cx="113" cy="19" r="4" fill="#5BBF8E" stroke="white" stroke-width="2"/><circle cx="226" cy="10" r="4" fill="#5BBF8E" stroke="white" stroke-width="2"/><circle cx="340" cy="10" r="5" fill="#5BBF8E" stroke="white" stroke-width="2.5"/>
          <text x="326" y="6" font-size="9" fill="#3A8F68" font-weight="800" font-family="Nunito">9/10</text>
          <text x="0" y="115" font-size="8" fill="#C8E4FA" font-family="Nunito" font-weight="700" text-anchor="middle">Nov</text>
          <text x="113" y="115" font-size="8" fill="#C8E4FA" font-family="Nunito" font-weight="700" text-anchor="middle">Jan</text>
          <text x="226" y="115" font-size="8" fill="#C8E4FA" font-family="Nunito" font-weight="700" text-anchor="middle">Mar</text>
          <text x="340" y="115" font-size="8" fill="#7F8C8D" font-family="Nunito" font-weight="800" text-anchor="middle">Auj.</text>
        </svg>
      </div>
    </div>
    <div class="vision-legend">
      <div class="vleg"><div class="vleg-line" style="background:#4A90D9"></div>≈íil droit</div>
      <div class="vleg"><div class="vleg-line" style="background:#5BBF8E"></div>≈íil gauche</div>
    </div>
  </div>

  <!-- TAUX D'OBSERVANCE -->
  <div class="section-title">üìä Taux d'observance</div>
  <div class="card">
    <div class="obs-big">
      <div class="obs-pct">84%</div>
      <div class="obs-label">Ce mois ¬∑ objectif 4h/jour</div>
    </div>
    <div class="obs-bar-wrap"><div class="obs-bar" id="obs-bar" style="width:0%"></div></div>
    <div class="obs-months">
      <div class="obs-month"><div class="obs-month-val">91%</div><div class="obs-month-label">D√©cembre</div></div>
      <div class="obs-month"><div class="obs-month-val">78%</div><div class="obs-month-label">Janvier</div></div>
      <div class="obs-month"><div class="obs-month-val">84%</div><div class="obs-month-label">F√©vrier</div></div>
    </div>
  </div>

  <!-- BADGES -->
  <div class="section-title">üèÜ Badges & r√©compenses</div>
  <div class="card">
    <div class="card-title">‚≠ê √âtoiles gagn√©es</div>
    <div class="stars-row" id="stars-row"></div>
    <div class="stars-sub">47 √©toiles sur 50 ‚Äî continue comme √ßa Jules ! üí™</div>
    <div class="badges-grid" id="badges-grid"></div>
  </div>

  <div style="margin:10px 16px;display:flex;flex-direction:column;gap:8px;" id="badges-list-prog"></div>
  <div style="height:8px"></div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE : MES DOCS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-docs">

  <div class="app-header">
    <img src="amblyup-logo.png" alt="Amblyup" class="header-logo">
  </div>

  <!-- ORDONNANCES -->
  <div class="section-title">üìÑ Ordonnances</div>
  <div style="margin:0 16px">
    <div class="ordo-item">
      <div class="ordo-icon">ü©π</div>
      <div class="ordo-info"><div class="ordo-title">Ordonnance cache-≈ìil</div><div class="ordo-date">Dr. Benali ¬∑ 15 janvier 2026 ¬∑ 20 s√©ances</div></div>
      <button class="ordo-btn">Voir</button>
    </div>
    <div class="ordo-item" style="border-color:var(--green)">
      <div class="ordo-icon" style="background:var(--green-l)">üëì</div>
      <div class="ordo-info"><div class="ordo-title">Ordonnance lunettes</div><div class="ordo-date">Dr. Benali ¬∑ 15 janvier 2026</div></div>
      <button class="ordo-btn" style="background:var(--green)">Voir</button>
    </div>
  </div>

  <!-- POUR LES PARENTS -->
  <div class="doc-section-hd">üë®‚Äçüë©‚Äçüëß Pour les parents</div>

  <!-- Comprendre -->
  <div class="doc-list">
    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon blue">üìñ</div>
        <div class="doc-item-info"><div class="doc-item-title">Comprendre l'amblyopie</div><div class="doc-item-sub">Causes, d√©pistage, risques, traitement</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item" onclick="showToast('Ouverture‚Ä¶','blue')"><span class="doc-sub-icon">üìò</span><span class="doc-sub-text">L'amblyopie : causes, d√©pistage, risques</span><span class="doc-sub-badge pdf">PDF</span></div>
          <div class="doc-sub-item" onclick="showToast('Ouverture‚Ä¶','blue')"><span class="doc-sub-icon">üìó</span><span class="doc-sub-text">L'amblyoth√©rapie : objectifs, dispositifs, √©tapes cl√©s</span><span class="doc-sub-badge pdf">PDF</span></div>
        </div>
      </div>
    </div>

    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon orange">üí°</div>
        <div class="doc-item-info"><div class="doc-item-title">Conseils pratiques</div><div class="doc-item-sub">Poser, enlever, motiver, routine</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item"><span class="doc-sub-icon">üåÖ</span><span class="doc-sub-text">Les premiers jours : annoncer & pr√©parer</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">ü©π</span><span class="doc-sub-text">Poser le patch / filtre (infographie)</span><span class="doc-sub-badge new">Infographie</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üå∏</span><span class="doc-sub-text">Enlever le patch en douceur (soins de la peau)</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üéØ</span><span class="doc-sub-text">Customiser le patch</span><span class="doc-sub-badge new">Id√©es</span></div>
        </div>
      </div>
    </div>

    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon green">üéÆ</div>
        <div class="doc-item-info"><div class="doc-item-title">Motiver & cr√©er la routine</div><div class="doc-item-sub">Id√©es, poster, tableau de r√©compenses</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item"><span class="doc-sub-icon">üí°</span><span class="doc-sub-text">Id√©es pour motiver</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üñ®</span><span class="doc-sub-text">Poster √† imprimer</span><span class="doc-sub-badge pdf">PDF</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">‚≠ê</span><span class="doc-sub-text">Tableau de r√©compenses</span><span class="doc-sub-badge pdf">PDF</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">‚è±</span><span class="doc-sub-text">Timer visuel (mini-app)</span><span class="doc-sub-badge new">App</span></div>
        </div>
      </div>
    </div>

    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon teal">üí¨</div>
        <div class="doc-item-info"><div class="doc-item-title">T√©moignages & aller plus loin</div><div class="doc-item-sub">Familles, articles, guides officiels</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item"><span class="doc-sub-icon">üë®‚Äçüë©‚Äçüëß</span><span class="doc-sub-text">T√©moignages parents / enfants, courbes</span><span class="doc-sub-badge video">Vid√©o</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üì∞</span><span class="doc-sub-text">Articles vulgaris√©s</span><span class="doc-sub-badge pdf">PDF</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üìã</span><span class="doc-sub-text">Guides officiels (HAS, SFO)</span><span class="doc-sub-badge pdf">PDF</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">ü§ù</span><span class="doc-sub-text">Associations & groupes conseill√©s</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- POUR L'ENFANT -->
  <div class="doc-section-hd">üßí Pour l'enfant</div>
  <div class="doc-list">
    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon orange">üìö</div>
        <div class="doc-item-info"><div class="doc-item-title">Comprendre avec les enfants</div><div class="doc-item-sub">BD, infographies, mini-jeux</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item"><span class="doc-sub-icon">üé®</span><span class="doc-sub-text">BD : pourquoi je porte un cache ?</span><span class="doc-sub-badge new">Nouveau</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üñº</span><span class="doc-sub-text">Infographies illustr√©es</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üéÆ</span><span class="doc-sub-text">Mini-jeux p√©dagogiques</span><span class="doc-sub-badge new">App</span></div>
        </div>
      </div>
    </div>

    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon blue">üó£</div>
        <div class="doc-item-info"><div class="doc-item-title">Expliquer √† mes copains</div><div class="doc-item-sub">Cartes pr√™tes √† l'emploi</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item"><span class="doc-sub-icon">üÉè</span><span class="doc-sub-text">Cartes d'explication simples</span><span class="doc-sub-badge pdf">PDF</span></div>
        </div>
      </div>
    </div>

    <div class="doc-item" onclick="toggleDoc(this)">
      <div class="doc-item-hd">
        <div class="doc-item-icon green">üí™</div>
        <div class="doc-item-info"><div class="doc-item-title">Rester motiv√©</div><div class="doc-item-sub">Livres, films, FAQ, t√©moignages</div></div>
        <div class="doc-item-arrow">‚Ä∫</div>
      </div>
      <div class="doc-item-body">
        <div class="doc-sub-list">
          <div class="doc-sub-item"><span class="doc-sub-icon">üìñ</span><span class="doc-sub-text">Livres / films par √¢ge</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">‚ùì</span><span class="doc-sub-text">FAQ enfant ‚Äî mes questions</span></div>
          <div class="doc-sub-item"><span class="doc-sub-icon">üé•</span><span class="doc-sub-text">T√©moignages d'anciens amblyopes</span><span class="doc-sub-badge video">Vid√©o</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- KITS PRATIQUES -->
  <div class="doc-section-hd">üñ® Kits pratiques √† imprimer</div>
  <div style="margin:0 16px">
    <div class="kit-card" onclick="toggleKit(this)">
      <div class="kit-hd">
        <div class="kit-icon" style="background:var(--blue-l)">üè´</div>
        <div class="kit-info"><div class="kit-title">Kit instituteur</div><div class="kit-sub">Pour expliquer √† l'√©cole</div></div>
        <div style="color:var(--text-l);font-size:.95rem;transition:transform .2s">‚Ä∫</div>
      </div>
      <div class="kit-body">
        <button class="kit-dl-btn blue">üìÑ Fiche "Amblyopie en 2 min"</button>
        <button class="kit-dl-btn orange">üìÖ Rythme actualis√© de l'enfant</button>
        <button class="kit-dl-btn green">üéì Expliquer aux autres enfants</button>
      </div>
    </div>

    <div class="kit-card" onclick="toggleKit(this)">
      <div class="kit-hd">
        <div class="kit-icon" style="background:var(--green-l)">üë®‚Äçüë©‚Äçüë¶</div>
        <div class="kit-info"><div class="kit-title">Kit famille √©largie</div><div class="kit-sub">Grands-parents, oncles, tantes...</div></div>
        <div style="color:var(--text-l);font-size:.95rem;transition:transform .2s">‚Ä∫</div>
      </div>
      <div class="kit-body">
        <button class="kit-dl-btn blue">üìÑ Fiche "Comprendre en 2 min"</button>
        <button class="kit-dl-btn green">üñ® Planning imprimable (p√©riode au choix)</button>
      </div>
    </div>
  </div>
  <div style="height:8px"></div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE : R√âGLAGES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page-reglages">

  <div class="app-header">
    <img src="amblyup-logo.png" alt="Amblyup" class="header-logo">
  </div>

  <!-- PROFIL -->
  <div class="section-title">üë§ Profil</div>
  <div class="card" style="display:flex;align-items:center;gap:14px;">
    <div style="width:56px;height:56px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:1.6rem;color:white;font-family:'Nunito',sans-serif;font-weight:900;flex-shrink:0;">J</div>
    <div style="flex:1">
      <div style="font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;">Jules</div>
      <div style="font-size:.75rem;color:var(--text-m);margin-top:2px;">8 ans ¬∑ Amblyopie OD ¬∑ Dr. Benali</div>
    </div>
    <button style="background:var(--blue-l);border:none;border-radius:10px;padding:7px 12px;font-family:'Nunito',sans-serif;font-weight:700;font-size:.75rem;color:var(--blue);cursor:pointer;">Modifier</button>
  </div>

  <!-- NOTIFICATIONS -->
  <div class="section-title">üîî Notifications</div>
  <div class="settings-section">
    <div class="toggle-row">
      <div class="toggle-info"><div class="toggle-title">Rappel matin ‚Äî mettre le cache</div><div class="toggle-sub">Chaque jour √† 8h00</div></div>
      <label class="toggle"><input type="checkbox" checked id="t-matin"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <div class="toggle-info"><div class="toggle-title">Rappel soir ‚Äî valider l'observance</div><div class="toggle-sub">Chaque jour √† 18h00</div></div>
      <label class="toggle"><input type="checkbox" checked id="t-soir"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <div class="toggle-info"><div class="toggle-title">Rappels de rendez-vous</div><div class="toggle-sub">J-2 et J-1 avant chaque RDV</div></div>
      <label class="toggle"><input type="checkbox" checked id="t-rdv"><span class="toggle-slider"></span></label>
    </div>
    <div class="toggle-row">
      <div class="toggle-info"><div class="toggle-title">Notifications badges & √©toiles</div><div class="toggle-sub">Quand Jules d√©bloque une r√©compense</div></div>
      <label class="toggle"><input type="checkbox" checked id="t-badges"><span class="toggle-slider"></span></label>
    </div>
  </div>

  <!-- TESTER NOTIFS -->
  <div class="section-title">üì£ Tester les rappels</div>
  <div class="card">
    <div class="perm-banner" id="perm-banner-2" style="margin:0 0 12px;display:none;">
      <p>üîî Active les notifications d'abord !</p>
      <button onclick="demanderPermission()">üîî Activer</button>
    </div>
    <button class="rappel-btn-test" style="width:100%;border:none;border-radius:14px;padding:16px;margin-bottom:8px;background:var(--blue);color:white;font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem;cursor:pointer;display:flex;align-items:center;gap:10px;text-align:left;box-shadow:0 4px 14px rgba(74,144,217,.3);" onclick="envoyerNotifDelai('cache',this)">
      <span style="font-size:1.4rem">üè¥‚Äç‚ò†Ô∏è</span>
      <span>Rappel : mettre le cache<br><span style="font-size:.75rem;opacity:.85;font-weight:500">Envoi dans 5 secondes‚Ä¶</span></span>
    </button>
    <button class="rappel-btn-test" style="width:100%;border:none;border-radius:14px;padding:16px;margin-bottom:8px;background:var(--green);color:white;font-family:'Nunito',sans-serif;font-weight:800;font-size:.9rem;cursor:pointer;display:flex;align-items:center;gap:10px;text-align:left;box-shadow:0 4px 14px rgba(91,191,142,.3);" onclick="envoyerNotifDelai('retirer',this)">
      <span style="font-size:1.4rem">üéâ</span>
      <span>Pr√™t √† remplir l'observance<br><span style="font-size:.75rem;opacity:.85;font-weight:500">Envoi dans 5 secondes‚Ä¶</span></span>
    </button>
    <div class="notif-status" id="notif-status">üí§ En attente</div>
  </div>

  <!-- PARAM√àTRES TRAITEMENT -->
  <div class="section-title">‚öôÔ∏è Param√®tres du traitement</div>
  <div class="settings-section">
    <div class="settings-item">
      <div class="settings-icon" style="background:var(--blue-l)">üéØ</div>
      <div class="settings-info"><div class="settings-title">Objectif quotidien de cache</div><div class="settings-sub">Actuellement : 4h / jour</div></div>
      <div class="settings-arrow">‚Ä∫</div>
    </div>
    <div class="settings-item">
      <div class="settings-icon" style="background:var(--orange-l)">‚è∞</div>
      <div class="settings-info"><div class="settings-title">Plage horaire du cache</div><div class="settings-sub">8h00 ‚Äì 18h00</div></div>
      <div class="settings-arrow">‚Ä∫</div>
    </div>
    <div class="settings-item">
      <div class="settings-icon" style="background:var(--green-l)">üëÅ</div>
      <div class="settings-info"><div class="settings-title">≈íil amblyope</div><div class="settings-sub">≈íil droit (OD)</div></div>
      <div class="settings-arrow">‚Ä∫</div>
    </div>
  </div>

  <!-- COMPTE -->
  <div class="section-title">üîß Compte</div>
  <div class="settings-section">
    <div class="settings-item">
      <div class="settings-icon" style="background:var(--blue-l)">üì±</div>
      <div class="settings-info"><div class="settings-title">Installer sur l'√©cran d'accueil</div><div class="settings-sub">Acc√®s rapide comme une vraie app</div></div>
      <div class="settings-arrow">‚Ä∫</div>
    </div>
    <div class="settings-item">
      <div class="settings-icon" style="background:var(--green-l)">üîí</div>
      <div class="settings-info"><div class="settings-title">Confidentialit√© & donn√©es</div><div class="settings-sub">RGPD ¬∑ HDS certifi√©</div></div>
      <div class="settings-arrow">‚Ä∫</div>
    </div>
    <div class="settings-item" onclick="showToast('Version 1.0.0 ‚Äî Amblyup','blue')">
      <div class="settings-icon" style="background:var(--bg)">‚ÑπÔ∏è</div>
      <div class="settings-info"><div class="settings-title">√Ä propos d'Amblyup</div><div class="settings-sub">Version 1.0.0</div></div>
      <div class="settings-arrow">‚Ä∫</div>
    </div>
  </div>
  <div style="height:8px"></div>

</div>

<!-- ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ -->
<nav class="bottom-nav">
  <button class="bnav active" id="bnav-0" onclick="goPage('page-agenda')"><img class="bnav-img" src="calendrier.png" alt="agenda"><span class="bnav-label">Mon agenda</span></button>
  <button class="bnav" id="bnav-1" onclick="goPage('page-progres')"><img class="bnav-img" src="progres.png" alt="progr√®s"><span class="bnav-label">Mes progr√®s</span></button>
  <button class="bnav" id="bnav-2" onclick="goPage('page-docs')"><img class="bnav-img" src="docs.png" alt="docs"><span class="bnav-label">Mes Docs</span></button>
  <button class="bnav" id="bnav-3" onclick="goPage('page-reglages')"><img class="bnav-img" src="reglages.png" alt="r√©glages"><span class="bnav-label">R√©glages</span></button>
</nav>

<!-- CONFETTI -->
<div class="confetti-wrap" id="confetti"></div>

<script>
'use strict';
let swReg = null;
let selectedH = null;
const OBJ = 4;
let calYear = 2026, calMonth = 1;
const CAL_CACHE = {};
const MONTHS_FR = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const NEXT_RDV = new Date(2026, 2, 3); // 3 mars 2026

window.addEventListener('load', async () => {
  try {
    if ('serviceWorker' in navigator) {
      try { swReg = await navigator.serviceWorker.register('sw.js'); } catch(e) {}
    }
    if ('Notification' in window && Notification.permission === 'default') {
      const b1 = document.getElementById('perm-banner');
      const b2 = document.getElementById('perm-banner-2');
      if(b1) b1.style.display = 'block';
      if(b2) b2.style.display = 'block';
    }
    initDate();
    buildHoursGrid();
    buildCalendar();
    buildStars('stars-row', 47, 10);
    buildBadgesGrid();
    buildBadgesList('badges-list-prog');
    buildPending();
    setTimeout(() => { const b = document.getElementById('obs-bar'); if(b) b.style.width = '84%'; }, 400);
  } catch(e) { console.error('Init error:', e); }
});

async function demanderPermission() {
  const perm = await Notification.requestPermission();
  if (perm === 'granted') {
    document.getElementById('perm-banner').style.display = 'none';
    document.getElementById('perm-banner-2').style.display = 'none';
    showToast('üîî Notifications activ√©es !','green');
  }
}

function goPage(id) {
  const target = document.getElementById(id);
  if (!target) return;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  target.classList.add('active');
  document.querySelectorAll('.bnav').forEach(b => b.classList.remove('active'));
  const map = {'page-agenda':0,'page-progres':1,'page-docs':2,'page-reglages':3};
  const idx = map[id];
  const bnavs = document.querySelectorAll('.bnav');
  if (idx !== undefined && bnavs[idx]) bnavs[idx].classList.add('active');
  try { window.scrollTo(0,0); } catch(e) {}
  try { target.scrollTop = 0; document.documentElement.scrollTop = 0; document.body.scrollTop = 0; } catch(e) {}
}

function initDate() {
  const d = new Date();
  const J = ['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  const M = ['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
  const str = J[d.getDay()] + ' ' + d.getDate() + ' ' + M[d.getMonth()] + ' ' + d.getFullYear();
  const el = document.getElementById('hero-date-str');
  if(el) el.textContent = str;
  const el2 = document.getElementById('rappel-date');
  if(el2) el2.textContent = str;
  updateDayBar();
  setInterval(updateDayBar, 60000);
}

function updateDayBar() {
  const now = new Date();
  const startMin = 8*60, endMin = 18*60;
  const nowMin = now.getHours()*60 + now.getMinutes();
  let pct = 0;
  if (nowMin >= startMin && nowMin <= endMin) pct = Math.round((nowMin-startMin)/(endMin-startMin)*100);
  else if (nowMin > endMin) pct = 100;
  const bar = document.getElementById('hero-day-bar');
  const marker = document.getElementById('hero-day-marker');
  const label = document.getElementById('hero-now-label');
  if(bar) setTimeout(()=>{ bar.style.width=pct+'%'; }, 400);
  if(marker) setTimeout(()=>{ marker.style.left=pct+'%'; }, 400);
  if(label) { const hh=now.getHours(),mm=String(now.getMinutes()).padStart(2,'0'); label.textContent=hh+'h'+mm; }
}

// ‚îÄ‚îÄ Prescription : Lun+Mar = OD, Mer+Jeu+Ven = OG, Sam+Dim = pas de cache
// Prochain RDV : 3 mars 2026 ‚Üí on remplit jusqu'au 3 mars inclus

function eyeForDate(date) {
  const dow = date.getDay(); // 0=dim, 1=lun, 2=mar, 3=mer, 4=jeu, 5=ven, 6=sam
  if (dow === 1 || dow === 2) return 'OD';      // lun + mar
  if (dow === 3 || dow === 4 || dow === 5) return 'OG'; // mer + jeu + ven
  return 'none'; // sam + dim
}

function buildDayEntry(year, month, d) {
  const date = new Date(year, month, d);
  const today = new Date(); today.setHours(0,0,0,0);
  date.setHours(0,0,0,0);
  const isToday = date.getTime() === today.getTime();
  const isFuture = date > today;
  const pastRdv = date > NEXT_RDV;

  if (isToday) return {d, s:'today', eye: eyeForDate(date), obs:'?'};
  if (isFuture || pastRdv) return {d, s:'future'};

  const eye = eyeForDate(date);
  // Observance simul√©e : quelques partiels et un manqu√© pour la d√©mo
  const dateKey = year*10000 + (month+1)*100 + d;
  const partials = [20260204, 20260207, 20260214, 20260218, 20260221];
  const missed   = [20260209];
  const unknown  = [20260219, 20260221, 20260222]; // jours non renseign√©s

  let obs;
  if (unknown.includes(dateKey)) obs = '?';
  else if (missed.includes(dateKey)) obs = 'miss';
  else if (partials.includes(dateKey)) obs = 'partial';
  else obs = 'ok';

  // Statut global de la case
  const s = obs === 'miss' ? 'miss' : obs === 'partial' ? 'partial' : obs === '?' ? 'unknown' : 'ok';
  return {d, s, eye, obs};
}

function generateRichMonth(year, month) {
  const firstDate = new Date(year, month, 1);
  const dow = firstDate.getDay();
  const firstDow = (dow === 0 ? 6 : dow - 1);
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const days = [];
  for (let i = 0; i < firstDow; i++) days.push(null);
  for (let d = 1; d <= daysInMonth; d++) days.push(buildDayEntry(year, month, d));
  // Calcul score (jours pass√©s non-weekend avec obs=ok ou partial)
  const today = new Date(); today.setHours(0,0,0,0);
  let total = 0, ok = 0;
  days.forEach(day => {
    if (!day) return;
    const date = new Date(year, month, day.d); date.setHours(0,0,0,0);
    if (date >= today || day.s === 'future') return;
    if (day.eye === 'none') return; // weekend = pas de prescription
    total++;
    if (day.obs === 'ok') ok++;
    else if (day.obs === 'partial') ok += 0.5;
  });
  const score = total > 0 ? Math.round(ok/total*100) : null;
  return {days, score};
}


function getCalData(year, month) {
  const key = year+'-'+String(month+1).padStart(2,'0');
  if (!CAL_CACHE[key]) CAL_CACHE[key] = generateRichMonth(year, month);
  return CAL_CACHE[key];
}

function buildCalendar() {
  const data = getCalData(calYear, calMonth);
  const label = document.getElementById('cal-month-label');
  if(label) label.textContent = MONTHS_FR[calMonth]+' '+calYear;
  const scoreEl = document.getElementById('cal-score-val');
  if(scoreEl) scoreEl.textContent = data.score != null ? data.score+'%' : '‚Äî';
  const grid = document.getElementById('cal-grid');
  if(!grid) return;
  grid.innerHTML = '';
  data.days.forEach(day => {
    const el = document.createElement('div');
    el.style.cssText = 'aspect-ratio:1;border-radius:9px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:Nunito,sans-serif;font-size:.62rem;font-weight:700;transition:transform .15s;position:relative;cursor:default;gap:1px;';

    if (!day) {
      el.style.background = 'none';
      grid.appendChild(el); return;
    }
    if (day.s === 'future') {
      el.style.cssText += 'background:var(--bg);color:var(--text-l);';
      el.innerHTML = '<span style="font-size:.6rem;line-height:1;color:var(--text-l)">'+day.d+'</span>';
      grid.appendChild(el); return;
    }
    if (day.s === 'today') {
      el.style.cssText += 'background:#2E6DB4;color:white;box-shadow:0 3px 10px rgba(74,144,217,.45);';
      const eyeLbl = day.eye==='OD'?'OD':day.eye==='OG'?'OG':'‚Äî';
      el.innerHTML =
        '<span style="font-size:.68rem;font-weight:900;line-height:1;color:white">'+day.d+'</span>'+
        '<span style="font-size:.5rem;font-weight:900;background:rgba(255,255,255,.3);border-radius:3px;padding:1px 3px;color:white;line-height:1.5;">'+eyeLbl+'</span>'+
        '<div style="width:11px;height:11px;border-radius:50%;background:rgba(255,255,255,.45);border:2px solid rgba(255,255,255,.8);display:flex;align-items:center;justify-content:center;font-size:.42rem;font-weight:900;color:white;margin-top:1px;">?</div>';
      el.addEventListener('mouseenter', ()=>el.style.transform='scale(1.1)');
      el.addEventListener('mouseleave', ()=>el.style.transform='');
      grid.appendChild(el); return;
    }

    // Couleur fond = quel ≈ìil
    let bgColor, textColor, eyeLabel, eyeBg, eyeTextC;
    if (day.eye === 'OD') {
      bgColor='#4A90D9'; textColor='white'; eyeLabel='OD';
      eyeBg='rgba(255,255,255,.3)'; eyeTextC='white';
    } else if (day.eye === 'OG') {
      bgColor='#3ABFBF'; textColor='white'; eyeLabel='OG';
      eyeBg='rgba(255,255,255,.3)'; eyeTextC='white';
    } else {
      bgColor='#CBD5E1'; textColor='#475569'; eyeLabel='‚Äî';
      eyeBg='rgba(0,0,0,.12)'; eyeTextC='#475569';
    }

    // Point observance ‚Äî plus grand, texte lisible
    let dotBg, dotBorder, dotContent='', dotColor='white', dotSize='11px';
    if (day.obs === 'ok')       { dotBg='#27AE60'; dotBorder='rgba(39,174,96,.5)'; }
    else if (day.obs==='partial'){ dotBg='#F39C12'; dotBorder='rgba(243,156,18,.5)'; }
    else if (day.obs==='miss')  { dotBg='#E74C3C'; dotBorder='rgba(231,76,60,.5)'; }
    else if (day.obs==='?')     {
      dotBg='rgba(255,255,255,.45)'; dotBorder='rgba(255,255,255,.8)';
      dotContent='?'; dotColor= day.eye==='none'?'#475569':'white';
    }
    else { dotBg='transparent'; dotBorder='transparent'; dotSize='0px'; }

    el.style.cssText += 'background:'+bgColor+';color:'+textColor+';';
    el.innerHTML =
      // Num√©ro du jour ‚Äî grand et lisible
      '<span style="font-size:.68rem;font-weight:900;line-height:1;color:'+textColor+'">'+day.d+'</span>'+
      // Badge ≈ìil ‚Äî fond blanc semi-transparent, texte blanc gras
      '<span style="font-size:.5rem;font-weight:900;background:'+eyeBg+';border-radius:3px;padding:1px 3px;color:'+eyeTextC+';line-height:1.5;letter-spacing:.02em;">'+eyeLabel+'</span>'+
      // Dot observance ‚Äî 11px, couleur forte, texte ? si inconnu
      '<div style="width:'+dotSize+';height:'+dotSize+';border-radius:50%;background:'+dotBg+';border:2px solid '+dotBorder+';display:flex;align-items:center;justify-content:center;font-size:.38rem;font-weight:900;color:'+dotColor+';margin-top:1px;flex-shrink:0;">'+dotContent+'</div>';

    el.addEventListener('mouseenter', ()=>el.style.transform='scale(1.1)');
    el.addEventListener('mouseleave', ()=>el.style.transform='');
    grid.appendChild(el);
  });
}

function calPrev() { calMonth--; if(calMonth<0){calMonth=11;calYear--;} buildCalendar(); }
function calNext() { calMonth++; if(calMonth>11){calMonth=0;calYear++;} buildCalendar(); }

function buildHoursGrid() {
  const grid = document.getElementById('hours-grid');
  if(!grid) return;
  for (let h = 0; h <= 7; h++) {
    const btn = document.createElement('button');
    let cls = 'hbtn';
    if (h === 0) cls += ' zero';
    else if (h === OBJ) cls += ' target';
    else if (h > OBJ) cls += ' over';
    btn.className = cls;
    const sub = h === 0 ? 'üòî' : h === OBJ ? '‚≠ê objectif' : h > OBJ ? 'üèÜ super !' : (h===1?'heure':'heures');
    btn.innerHTML = h + 'h<span class="hbtn-sub">' + sub + '</span>';
    btn.onclick = () => selectHeure(btn, h);
    grid.appendChild(btn);
  }
}

function selectHeure(btn, h) {
  document.querySelectorAll('.hbtn').forEach(b => b.classList.remove('sel'));
  btn.classList.add('sel');
  selectedH = h;
  const vbtn = document.getElementById('valider-btn');
  vbtn.disabled = false;
  if (h >= OBJ) {
    vbtn.style.background = 'var(--green)';
    vbtn.textContent = h > OBJ ? 'üèÜ Valider ‚Äî Super Jules !' : '‚≠ê Valider ‚Äî Objectif atteint !';
  } else if (h === 0) {
    vbtn.style.background = 'var(--red)';
    vbtn.textContent = 'Valider üòî';
  } else {
    vbtn.style.background = 'var(--blue)';
    vbtn.textContent = 'Valider ‚úì';
  }
}

function validerSaisie() {
  if (selectedH === null) return;
  const h = selectedH;
  document.getElementById('saisie-form').style.display = 'none';
  document.getElementById('congrats-box').style.display = 'block';
  document.getElementById('saisie-card').classList.add('done');
  if (h >= OBJ) {
    document.getElementById('c-emoji').textContent = h > OBJ ? 'üèÜ' : 'üéâ';
    document.getElementById('c-title').textContent = h > OBJ ? 'üèÜ ' + h + 'h, incroyable Jules !' : 'üéâ Bravo Jules !';
    document.getElementById('c-sub').textContent = "C'est excellent ! Continue comme √ßa üí™";
    document.getElementById('mascot').textContent = h > OBJ ? 'üëë' : 'üèÜ';
    lancerConfetti();
  } else if (h === 0) {
    document.getElementById('c-emoji').textContent = 'üòî';
    document.getElementById('c-title').textContent = 'Pas de cache aujourd\'hui...';
    document.getElementById('c-sub').textContent = "N'oublie pas demain ! Tu peux le faire üí™";
  } else {
    document.getElementById('c-emoji').textContent = 'üëç';
    document.getElementById('c-title').textContent = 'üëç ' + h + 'h enregistr√©es !';
    document.getElementById('c-sub').textContent = "Bonne journ√©e, on continue demain !";
    document.getElementById('mascot').textContent = 'üí™';
  }
}


const PENDING = [
  {d:23, label:"Aujourd'hui", dayLabel:'Lun 23 f√©v', month:'F√©v', isToday:true,  eye:'OD', defaultStart:8,  defaultEnd:18},
  {d:19, label:'Jeu 19 f√©v',  dayLabel:'Jeu 19 f√©v',  month:'F√©v', isToday:false, eye:'OD', defaultStart:8,  defaultEnd:18},
  {d:21, label:'Sam 21 f√©v',  dayLabel:'Sam 21 f√©v',  month:'F√©v', isToday:false, eye:'OG', defaultStart:8,  defaultEnd:18},
];
let pendingDone = 0;
// Store per-item state: {start, end, validated}
const piState = PENDING.map(d => ({start: d.defaultStart, end: d.defaultEnd, validated: false}));

function hToPos(h) { return ((h - 6) / 16) * 100; } // 6h‚Üí22h = 16h range
function posToH(pct) { return Math.round(pct / 100 * 16 + 6); }
function fmtH(h) { return h + 'h00'; }

function buildPending() {
  const list = document.getElementById('pending-list');
  if(!list) return;
  const now = new Date();
  const after18 = now.getHours() >= 18;

  PENDING.forEach((day, i) => {
    const isLocked = day.isToday && !after18;
    const eyeColor = day.eye === 'OD' ? '#4A90D9' : '#3ABFBF';
    const eyeBg    = day.eye === 'OD' ? '#EBF4FB' : '#E8F8F8';
    const el = document.createElement('div');
    el.id = 'pi-' + i;
    el.style.cssText = 'border-radius:16px;border:2px solid '+eyeColor+'33;padding:14px;margin-bottom:10px;background:'+eyeBg+';transition:opacity .4s,transform .4s;';

    // Header row
    const hdr = document.createElement('div');
    hdr.style.cssText = 'display:flex;align-items:center;gap:10px;margin-bottom:12px;';
    hdr.innerHTML =
      '<div style="width:44px;height:48px;border-radius:12px;background:'+eyeColor+';display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;">' +
        '<span style="font-family:Nunito,sans-serif;font-weight:900;font-size:'+(day.isToday?'1.2':'1')+'rem;color:white;line-height:1;">'+(day.isToday?'üìÖ':day.d)+'</span>' +
        (day.isToday ? '' : '<span style="font-size:.55rem;font-weight:700;color:rgba(255,255,255,.85);text-transform:uppercase;">'+day.month+'</span>') +
      '</div>' +
      '<div style="flex:1;">' +
        '<div style="font-family:Nunito,sans-serif;font-weight:900;font-size:.9rem;color:'+eyeColor+';">'+day.label+'</div>' +
        '<div style="font-size:.72rem;color:#64748B;margin-top:2px;">Cache '+day.eye+' ¬∑ objectif 8h‚Üí18h</div>' +
        (isLocked ? '<div style="font-size:.68rem;color:#F39C12;font-weight:700;margin-top:3px;">üîí Renseignement disponible apr√®s 18h</div>' : '') +
      '</div>';
    el.appendChild(hdr);

    if (!isLocked) {
      // Duration badge
      const durDiv = document.createElement('div');
      durDiv.id = 'pi-dur-'+i;
      durDiv.style.cssText = 'text-align:center;margin-bottom:10px;';
      durDiv.innerHTML = '<span style="font-family:Nunito,sans-serif;font-size:1.4rem;font-weight:900;color:'+eyeColor+';">'+
        (piState[i].end - piState[i].start)+'h port√©es</span>' +
        '<span style="font-size:.75rem;color:#64748B;margin-left:8px;">'+fmtH(piState[i].start)+' ‚Üí '+fmtH(piState[i].end)+'</span>';
      el.appendChild(durDiv);

      // Range slider track
      const trackWrap = document.createElement('div');
      trackWrap.style.cssText = 'position:relative;height:44px;margin:0 8px 6px;user-select:none;';
      trackWrap.innerHTML = `
        <!-- Track bg -->
        <div style="position:absolute;top:50%;left:0;right:0;height:10px;border-radius:5px;background:#CBD5E1;transform:translateY(-50%);"></div>
        <!-- Filled zone -->
        <div id="pi-fill-${i}" style="position:absolute;top:50%;height:10px;border-radius:5px;background:${eyeColor};transform:translateY(-50%);transition:left .05s,width .05s;pointer-events:none;"></div>
        <!-- Trait objectif 8h -->
        <div style="position:absolute;top:8px;height:26px;width:2.5px;border-radius:2px;background:#27AE60;left:${hToPos(8)}%;transform:translateX(-50%);pointer-events:none;" title="Objectif d√©but 8h">
          <span style="position:absolute;top:28px;left:50%;transform:translateX(-50%);font-size:.48rem;font-weight:800;color:#27AE60;white-space:nowrap;">8h</span>
        </div>
        <!-- Trait objectif 18h -->
        <div style="position:absolute;top:8px;height:26px;width:2.5px;border-radius:2px;background:#27AE60;left:${hToPos(18)}%;transform:translateX(-50%);pointer-events:none;" title="Objectif fin 18h">
          <span style="position:absolute;top:28px;left:50%;transform:translateX(-50%);font-size:.48rem;font-weight:800;color:#27AE60;white-space:nowrap;">18h</span>
        </div>
        <!-- Handle start -->
        <div id="pi-hs-${i}" data-pi="${i}" data-side="start"
          style="position:absolute;top:50%;width:26px;height:26px;border-radius:50%;background:white;border:3px solid ${eyeColor};box-shadow:0 2px 8px rgba(0,0,0,.2);transform:translate(-50%,-50%);cursor:grab;touch-action:none;z-index:2;display:flex;align-items:center;justify-content:center;">
          <span style="font-size:.5rem;font-weight:900;color:${eyeColor};">‚ñ∂</span>
        </div>
        <!-- Handle end -->
        <div id="pi-he-${i}" data-pi="${i}" data-side="end"
          style="position:absolute;top:50%;width:26px;height:26px;border-radius:50%;background:white;border:3px solid ${eyeColor};box-shadow:0 2px 8px rgba(0,0,0,.2);transform:translate(-50%,-50%);cursor:grab;touch-action:none;z-index:2;display:flex;align-items:center;justify-content:center;">
          <span style="font-size:.5rem;font-weight:900;color:${eyeColor};">‚óÄ</span>
        </div>
        <!-- Labels min/max -->
        <div style="position:absolute;top:-14px;left:0;font-size:.52rem;color:#94A3B8;font-weight:700;">6h</div>
        <div style="position:absolute;top:-14px;right:0;font-size:.52rem;color:#94A3B8;font-weight:700;">22h</div>
      `;
      el.appendChild(trackWrap);

      // Validate button
      const valBtn = document.createElement('button');
      valBtn.id = 'pi-vbtn-'+i;
      valBtn.style.cssText = 'width:100%;padding:12px;border-radius:12px;border:none;background:'+eyeColor+';color:white;font-family:Nunito,sans-serif;font-weight:900;font-size:.9rem;cursor:pointer;margin-top:8px;transition:opacity .2s;';
      valBtn.textContent = '‚úì Valider ce jour';
      valBtn.onclick = () => validatePiDay(i);
      el.appendChild(valBtn);

      // Congrats box (hidden)
      const cbox = document.createElement('div');
      cbox.id = 'pi-cbox-'+i;
      cbox.style.cssText = 'display:none;text-align:center;padding:12px 0 4px;';
      el.appendChild(cbox);
    }

    list.appendChild(el);
    if (!isLocked) {
      updatePiSlider(i);
      initPiDrag(i);
    }
  });
}

function updatePiSlider(i) {
  const s = piState[i].start, e = piState[i].end;
  const sp = hToPos(s), ep = hToPos(e);
  const hs = document.getElementById('pi-hs-'+i);
  const he = document.getElementById('pi-he-'+i);
  const fill = document.getElementById('pi-fill-'+i);
  const dur = document.getElementById('pi-dur-'+i);
  if (hs) hs.style.left = sp+'%';
  if (he) he.style.left = ep+'%';
  if (fill) { fill.style.left = sp+'%'; fill.style.width = (ep-sp)+'%'; }
  if (dur) {
    const hours = e - s;
    const OBJ_S = 8, OBJ_E = 18;
    const covered = Math.max(0, Math.min(e, OBJ_E) - Math.max(s, OBJ_S));
    const pct = Math.round(covered / (OBJ_E - OBJ_S) * 100);
    let col = hours >= (OBJ_E-OBJ_S) ? '#27AE60' : hours >= 5 ? '#F39C12' : '#E74C3C';
    dur.innerHTML = '<span style="font-family:Nunito,sans-serif;font-size:1.4rem;font-weight:900;color:'+col+';">'+hours+'h port√©es</span>'+
      '<span style="font-size:.75rem;color:#64748B;margin-left:8px;">'+fmtH(s)+' ‚Üí '+fmtH(e)+'</span>'+
      '<div style="font-size:.7rem;color:'+col+';font-weight:700;margin-top:2px;">'+pct+'% de l\'objectif couvert</div>';
  }
}

function initPiDrag(i) {
  ['pi-hs-'+i, 'pi-he-'+i].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    const side = el.dataset.side;
    let dragging = false;

    const getTrack = () => el.closest('div[style*="position:relative"]') ||
      el.parentElement;

    const handleMove = (clientX) => {
      const track = el.parentElement;
      const rect = track.getBoundingClientRect();
      let pct = Math.max(0, Math.min(100, (clientX - rect.left) / rect.width * 100));
      let h = posToH(pct);
      h = Math.max(6, Math.min(22, h));
      if (side === 'start') {
        piState[i].start = Math.min(h, piState[i].end - 1);
      } else {
        piState[i].end = Math.max(h, piState[i].start + 1);
      }
      updatePiSlider(i);
    };

    // Mouse
    el.addEventListener('mousedown', (ev) => { dragging = true; ev.preventDefault(); });
    document.addEventListener('mousemove', (ev) => { if (dragging) handleMove(ev.clientX); });
    document.addEventListener('mouseup', () => { dragging = false; });

    // Touch
    el.addEventListener('touchstart', (ev) => { dragging = true; ev.preventDefault(); }, {passive:false});
    document.addEventListener('touchmove', (ev) => { if (dragging) handleMove(ev.touches[0].clientX); }, {passive:true});
    document.addEventListener('touchend', () => { dragging = false; });
  });
}

function validatePiDay(i) {
  const s = piState[i].start, e = piState[i].end;
  const hours = e - s;
  const OBJ_HOURS = 10; // objectif 8h‚Üí18h = 10h
  const cbox = document.getElementById('pi-cbox-'+i);
  const vbtn = document.getElementById('pi-vbtn-'+i);
  const durDiv = document.getElementById('pi-dur-'+i);
  const day = PENDING[i];
  const eyeColor = day.eye === 'OD' ? '#4A90D9' : '#3ABFBF';

  if (vbtn) vbtn.style.display = 'none';
  if (durDiv) durDiv.style.display = 'none';
  // Hide slider
  const track = document.querySelector('#pi-hs-'+i)?.parentElement;
  if (track) track.style.display = 'none';

  let emoji, title, sub, doConfetti;
  if (hours >= OBJ_HOURS) {
    emoji='üèÜ'; title='Objectif atteint !'; sub='Bravo Jules, '+hours+'h port√©es ! Continue comme √ßa üí™'; doConfetti=true;
  } else if (hours >= OBJ_HOURS * 0.7) {
    emoji='üëç'; title='Bonne journ√©e !'; sub=hours+'h port√©es ¬∑ presque l\'objectif, c\'est bien ! üòä'; doConfetti=false;
  } else if (hours > 0) {
    emoji='üí™'; title='C\'est un d√©but !'; sub=hours+'h port√©es ¬∑ on peut faire mieux, courage !'; doConfetti=false;
  } else {
    emoji='üòî'; title='Pas de cache ce jour‚Ä¶'; sub='Pas grave, on rattrape demain ! üíô'; doConfetti=false;
  }

  if (cbox) {
    cbox.style.display = 'block';
    cbox.innerHTML =
      '<div style="font-size:2.2rem;margin-bottom:6px;">'+emoji+'</div>'+
      '<div style="font-family:Nunito,sans-serif;font-weight:900;font-size:1rem;color:'+eyeColor+';">'+title+'</div>'+
      '<div style="font-size:.8rem;color:#64748B;margin-top:4px;margin-bottom:10px;">'+sub+'</div>'+
      '<button onclick="resolvePi('+i+')" style="padding:8px 20px;border-radius:10px;border:none;background:'+eyeColor+';color:white;font-family:Nunito,sans-serif;font-weight:800;font-size:.8rem;cursor:pointer;">OK ‚úì</button>';
  }
  if (doConfetti) lancerConfetti();
  piState[i].validated = true;
}

function resolvePi(i) {
  const el = document.getElementById('pi-'+i);
  if (el) { el.style.opacity='0'; el.style.transform='translateX(20px)'; }
  pendingDone++;
  setTimeout(() => {
    if (el) el.remove();
    if (pendingDone >= PENDING.length) {
      const sec = document.getElementById('pending-section');
      if (sec) sec.style.display='none';
    }
  }, 400);
}

function togglePi(i) { /* legacy compat */ }
function buildPiGrid(i) { /* legacy compat */ }

// BADGES
const BADGES = [
  {icon:'ü¶∏',name:'Super H√©ros',desc:'7 jours d\'affil√©e',unlocked:true},
  {icon:'üèÜ',name:'Champion',desc:'10 jours streak',unlocked:true},
  {icon:'üåü',name:'√âtoile filante',desc:'30 √©toiles',unlocked:true},
  {icon:'üí™',name:'Pers√©v√©rant',desc:'20 jours ce mois',unlocked:true},
  {icon:'üëë',name:'Roi du cache',desc:'Objectif 7j/7',unlocked:false},
  {icon:'üöÄ',name:'D√©collage',desc:'1er mois complet',unlocked:false},
  {icon:'üåà',name:'Arc-en-ciel',desc:'50 √©toiles',unlocked:false},
  {icon:'üéØ',name:'Pr√©cision',desc:'100% en 1 semaine',unlocked:false},
];

function buildStars(id, total, max) {
  const row = document.getElementById(id); if(!row) return;
  const filled = Math.min(total % max || max, max);
  for (let i = 0; i < max; i++) {
    const s = document.createElement('span');
    s.className = 'star'+(i<filled?' filled':'');
    s.textContent = i<filled ? '‚≠ê' : '‚òÜ';
    s.style.animationDelay = (i*.06)+'s';
    row.appendChild(s);
  }
}

function buildBadgesGrid() {
  const grid = document.getElementById('badges-grid'); if(!grid) return;
  BADGES.forEach(b => {
    const el = document.createElement('div');
    el.className = 'badge-item'+(b.unlocked?' unlocked':'');
    el.innerHTML = '<span class="badge-icon">'+b.icon+'</span><span class="badge-name">'+b.name+'</span>';
    grid.appendChild(el);
  });
}

function buildBadgesList(id) {
  const list = document.getElementById(id); if(!list) return;
  BADGES.forEach(b => {
    const el = document.createElement('div');
    el.className = 'badge-row'+(b.unlocked?' unlocked':'');
    el.innerHTML = '<div class="badge-row-icon">'+b.icon+'</div><div class="badge-row-info"><div class="badge-row-name">'+b.name+'</div><div class="badge-row-desc">'+b.desc+'</div></div><div class="badge-row-status">'+(b.unlocked?'‚úì Obtenu':'üîí')+'</div>';
    list.appendChild(el);
  });
}

// DOCS accordion
function toggleDoc(el) {
  const isOpen = el.classList.contains('open');
  document.querySelectorAll('.doc-item.open').forEach(d => d.classList.remove('open'));
  if (!isOpen) el.classList.add('open');
}

function toggleKit(el) {
  el.classList.toggle('open');
}

// NOTIFICATIONS
function envoyerNotifDelai(type, btn) {
  let secs = 5;
  const originalHTML = btn.querySelector('span:last-child').innerHTML;
  btn.disabled = true;
  btn.style.opacity = '.7';
  btn.querySelector('span:last-child').innerHTML = 'Envoi dans <strong>'+secs+'s</strong>‚Ä¶<br><span style="font-size:.75rem;opacity:.85;font-weight:500">Prends ton t√©l√©phone !</span>';
  const interval = setInterval(() => {
    secs--;
    if (secs > 0) {
      btn.querySelector('span:last-child').innerHTML = 'Envoi dans <strong>'+secs+'s</strong>‚Ä¶<br><span style="font-size:.75rem;opacity:.85;font-weight:500">Prends ton t√©l√©phone !</span>';
    } else {
      clearInterval(interval);
      btn.querySelector('span:last-child').innerHTML = originalHTML;
      btn.disabled = false; btn.style.opacity = '1';
      envoyerNotif(type);
    }
  }, 1000);
}

async function envoyerNotif(type) {
  const statusEl = document.getElementById('notif-status');
  if (!('Notification' in window)) { showToast('‚ö†Ô∏è Non support√© sur ce navigateur','orange'); return; }
  if (Notification.permission === 'default') await demanderPermission();
  if (Notification.permission !== 'granted') {
    if(statusEl) { statusEl.innerHTML='‚ö†Ô∏è Permission refus√©e'; statusEl.style.background='var(--orange-l)'; statusEl.style.color='var(--orange-d)'; }
    setTimeout(() => { if(statusEl){statusEl.innerHTML='üí§ En attente';statusEl.style='';} }, 4000);
    return;
  }
  const notifs = {
    cache:   {title:'Cache-≈ìil de Jules üè¥‚Äç‚ò†Ô∏è', body:"Bonjour Jules, aujourd'hui mets le cache sur l'OD üëÅÔ∏è", url:window.location.href},
    retirer: {title:'Bravo Jules ! üéâ', body:"Tu peux retirer ton cache ! Dis-nous combien d'heures üåü", url:window.location.href+'#saisie'},
  };
  const n = notifs[type] || notifs.cache;
  try {
    if (swReg) await swReg.showNotification(n.title, {body:n.body,icon:'icon-192.png',badge:'icon-192.png',vibrate:[200,100,200],tag:type,data:{url:n.url}});
    else new Notification(n.title, {body:n.body});
    if(statusEl) { statusEl.innerHTML='‚úÖ Notification envoy√©e !'; statusEl.style.background='var(--green-l)'; statusEl.style.color='var(--green-d)'; }
  } catch(e) { if(statusEl) statusEl.innerHTML='‚ùå '+e.message; }
  setTimeout(() => { if(statusEl){statusEl.innerHTML='üí§ En attente';statusEl.style.background='';statusEl.style.color='';} }, 4000);
}

// CONFETTI
function lancerConfetti() {
  const wrap = document.getElementById('confetti');
  wrap.classList.add('show'); wrap.innerHTML = '';
  const colors = ['#4A90D9','#5BBF8E','#F9A825','#E74C3C','#C8E4FA','#2E6DB4'];
  for (let i = 0; i < 70; i++) {
    const el = document.createElement('div');
    el.className = 'confetti';
    el.style.cssText = 'left:'+Math.random()*100+'%;top:'+(-Math.random()*30)+'px;background:'+colors[~~(Math.random()*colors.length)]+';width:'+(6+Math.random()*8)+'px;height:'+(6+Math.random()*8)+'px;border-radius:'+(Math.random()>.5?'50%':'2px')+';--dur:'+(1+Math.random()*1.2)+'s;--delay:'+(Math.random()*.8)+'s';
    wrap.appendChild(el);
  }
  setTimeout(() => { wrap.classList.remove('show'); wrap.innerHTML=''; }, 3000);
}

// TOAST
function showToast(msg, color) {
  const t = document.createElement('div');
  t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--'+color+');color:white;padding:10px 18px;border-radius:12px;font-size:.82rem;font-weight:700;z-index:9999;box-shadow:0 6px 20px rgba(0,0,0,.15);font-family:Nunito,sans-serif;white-space:nowrap;animation:fadeUp .3s ease;';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(() => t.remove(), 2500);
}

function activateVtab(el) {
  document.querySelectorAll('.vtab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
}
</script>
</body>
</html>
